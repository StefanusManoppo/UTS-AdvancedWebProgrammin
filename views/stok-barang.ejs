<%- include('partials/header', {title: title, user: user}) %>

<div class="row">
    <div class="col-12">
        <h2>üì¶ Data Stok Barang</h2>
        <p class="text-gray">
            <% if (user.role === 'admin') { %>
                Full Access - Kelola stok barang
            <% } else if (user.role === 'montir') { %>
                Kelola dengan Approval - Perubahan memerlukan persetujuan admin
            <% } else { %>
                Read Only - Hanya dapat melihat data
            <% } %>
        </p>
        
        <% if (success) { %>
            <div class="alert alert-success"><%= success %></div>
        <% } %>
        
        <% if (error) { %>
            <div class="alert alert-danger"><%= error %></div>
        <% } %>
    </div>
</div>

<div class="row mt-4">
    <% if (user.role !== 'visitor') { %>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Tambah Stok Barang</h5>
                    <% if (user.role === 'montir') { %>
                        <small class="text-warning">‚ö†Ô∏è Memerlukan approval admin</small>
                    <% } %>
                </div>
                <div class="card-body">
                    <form method="POST" action="/stok/barang" id="formTambahStok">
                        <div class="mb-3">
                            <label for="nama_barang" class="form-label">Nama Barang</label>
                            <input type="text" class="form-control" id="nama_barang" name="nama_barang" required>
                        </div>
                        <div class="mb-3">
                            <label for="jumlah" class="form-label">Jumlah</label>
                            <input type="number" class="form-control" id="jumlah" name="jumlah" min="0" step="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="harga" class="form-label">Harga</label>
                            <input type="number" step="0.01" class="form-control" id="harga" name="harga" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="kategori" class="form-label">Kategori</label>
                            <select class="form-select" id="kategori" name="kategori" required>
                                <option value="">Pilih Kategori</option>
                                <option value="Oli">Oli</option>
                                <option value="Ban">Ban</option>
                                <option value="Aki">Aki</option>
                                <option value="Sparepart">Sparepart</option>
                                <option value="Tools">Tools</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <% if (user.role === 'admin') { %>
                                Tambah Stok
                            <% } else { %>
                                Request Tambah Stok
                            <% } %>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
    <% } else { %>
        <div class="col-md-12">
    <% } %>
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Daftar Stok Barang</h5>
                </div>
                <div class="card-body">
                    <% if (stok && stok.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama Barang</th>
                                        <th>Jumlah</th>
                                        <th>Harga</th>
                                        <th>Kategori</th>
                                        <% if (user.role !== 'visitor') { %>
                                            <th>Aksi</th>
                                        <% } %>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% stok.forEach((item, index) => { %>
                                        <tr>
                                            <td><%= index + 1 %></td>
                                            <td><%= item.nama_barang %></td>
                                            <td><%= item.jumlah %></td>
                                            <td>Rp <%= item.harga.toLocaleString('id-ID') %></td>
                                            <td>
                                                <span class="badge bg-secondary"><%= item.kategori %></span>
                                            </td>
                                            <% if (user.role !== 'visitor') { %>
                                                <td>
                                                    <a href="/stok/barang/edit/<%= item.id %>" class="btn btn-sm btn-warning">
                                                        <% if (user.role === 'admin') { %>Edit<% } else { %>Request Edit<% } %>
                                                    </a>
                                                    <form method="POST" action="/stok/barang/delete/<%= item.id %>" class="d-inline delete-form">
                                                        <button type="submit" class="btn btn-sm btn-danger" 
                                                                data-role="<%= user.role %>">
                                                            <% if (user.role === 'admin') { %>Hapus<% } else { %>Request Hapus<% } %>
                                                        </button>
                                                    </form>
                                                </td>
                                            <% } %>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <p class="text-center py-4 text-muted">Tidak ada data stok barang</p>
                    <% } %>
                </div>
            </div>
        </div>
</div>

<% if (user.role === 'visitor') { %>
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Mode Read Only</strong><br>
                Anda hanya dapat melihat data. Untuk menambah/edit/hapus data, hubungi Administrator.
            </div>
        </div>
    </div>
<% } %>

<script>
// Handle delete confirmation
document.addEventListener('DOMContentLoaded', function() {
    // Delete confirmation
    document.querySelectorAll('.delete-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const role = this.querySelector('button').getAttribute('data-role');
            const message = role === 'admin' ? 'Yakin ingin menghapus?' : 'Yakin ingin request hapus?';
            
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    });
    
    // Prevent negative numbers in form inputs
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            if (this.value < 0) {
                this.value = 0;
            }
        });
        
        // Prevent typing minus sign
        input.addEventListener('keydown', function(e) {
            if (e.key === '-' || e.key === 'e' || e.key === 'E') {
                e.preventDefault();
            }
        });
    });
    
    // Additional validation on form submit
    const form = document.getElementById('formTambahStok');
    if (form) {
        form.addEventListener('submit', function(e) {
            const jumlah = parseFloat(document.getElementById('jumlah').value);
            const harga = parseFloat(document.getElementById('harga').value);
            
            if (jumlah < 0 || harga < 0) {
                e.preventDefault();
                alert('Jumlah dan Harga tidak boleh bernilai negatif!');
                return false;
            }
        });
    }
});
</script>

<%- include('partials/footer') %>